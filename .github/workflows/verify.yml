name: verify

on:
  pull_request:
  push:
    branches: master

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
        
    - name: Set up Python
      uses: actions/setup-python@v1

    # ! dependents on other library
    - name: Update Submodules
      run: git submodule update --remote

    - name: Install dependencies
      run: pip3 install -U online-judge-verify-helper

    - name: Install ccache
      run: sudo apt-get update && sudo apt-get install -y ccache

    - name: Prepare toolchain (PCH)
      run: bash scripts/setup-toolchain.sh

    - name: Compile tests (CE check)
      run: bash scripts/ce-check.sh

    - name: Upload CE logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: ce-check-logs
        path: build/ce-check
        if-no-files-found: ignore

    - name: Fetch
      run: |
        git config remote.origin.fetch '+refs/heads/*:refs/remotes/origin/*'
        git fetch --all

    - name: Run tests
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        YUKICODER_TOKEN: ${{ secrets.YUKICODER_TOKEN }}
        GH_PAT: ${{ secrets.GH_PAT }}
      run: bash scripts/oj-verify.sh all --timeout 100000

    # - name: Run yukicoder
    #   env:
    #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #     YUKICODER_TOKEN: ${{ secrets.YUKICODER_TOKEN }}
    #     GH_PAT: ${{ secrets.GH_PAT }}
    #   run: oj-verify run test/yukicoder/117.test.cpp
